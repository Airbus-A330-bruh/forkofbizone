name: ğŸ¤– AI Auto Update Log

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-update:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'Auto AI Update Log')"

    steps:
      - name: ğŸš€ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“ Get recent commits context
        run: |
          echo "=== TRIGGERING COMMIT ==="
          git log -1 --pretty=%B > commit_message.txt
          cat commit_message.txt

      - name: ğŸ¤– Generate AI update block (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install requests

          python3 << 'EOF'
          import requests, os, datetime, random

          # Read the actual commit message that triggered this
          commit_message = open("commit_message.txt").read().strip()
          today = datetime.date.today().strftime("%B %d, %Y")
          
          version_names = ["Quantum", "Phoenix", "Nebula", "Velocity", "Horizon", "Infinity", "Cosmic", "Synergy"]
          version_adjectives = ["Update", "Release", "Launch", "Drop", "Upgrade", "Evolution"]
          
          version_name = f"{random.choice(version_names)} {random.choice(version_adjectives)}"
          version_number = f"1.{random.randint(1,20)}.{random.randint(0,9)}"

          api_key = os.environ["GEMINI_API_KEY"]
          
          # Use the CORRECT Gemini model that actually exists
          # gemini-1.5-pro is the correct model name for the latest version
          url = f"https://generativelanguage.googleapis.com/v1/models/gemini-1.5-pro:generateContent?key={api_key}"
          
          print(f"ğŸ¯ Using commit message: {commit_message}")
          print(f"ğŸ”— Using Gemini model: gemini-1.5-pro")

          prompt = f"""
          Create an engaging HTML update card for an unblocked games website based on this git commit: "{commit_message}"
          
          Return ONLY the HTML code with no explanations. Use this exact structure:

          <div class="update-item" style="animation-delay: 0.1s;">
            <div class="update-header">
              <div class="version-info">
                <span class="version-badge">v{version_number}</span>
                <h3 class="version-title">{version_name}</h3>
              </div>
              <span class="version-date">{today}</span>
            </div>
            <div class="update-content">
              <ul class="update-list">
                <li>âœ¨ Create 3-4 specific bullet points based on the commit</li>
                <li>ğŸ® Use gaming emojis and exciting language</li>
                <li>ğŸš€ Make it relevant to game website updates</li>
                <li>ğŸ¯ Be specific about what changed</li>
              </ul>
            </div>
          </div>
          """

          try:
              payload = {
                  "contents": [
                      {"parts": [{"text": prompt}]}
                  ],
                  "generationConfig": {
                      "temperature": 0.9,
                      "topK": 40,
                      "topP": 0.95,
                      "maxOutputTokens": 500,
                  }
              }

              print("ğŸš€ Sending request to Gemini API...")
              response = requests.post(url, json=payload, timeout=30)
              print(f"ğŸ“¡ Response status: {response.status_code}")
              
              if response.status_code != 200:
                  print(f"âŒ API Error {response.status_code}: {response.text}")
                  # Try one more model as fallback
                  print("ğŸ”„ Trying gemini-pro model...")
                  url_fallback = f"https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key={api_key}"
                  response = requests.post(url_fallback, json=payload, timeout=30)
                  print(f"ğŸ“¡ Fallback response status: {response.status_code}")
                  
                  if response.status_code != 200:
                      raise Exception(f"Both models failed. Last error: {response.text}")
              
              result = response.json()
              ai_text = result["candidates"][0]["content"]["parts"][0]["text"]
              
              # Clean the response
              cleaned_text = ai_text.strip()
              cleaned_text = cleaned_text.replace('```html', '').replace('```', '').strip()
              
              # Validate we got proper HTML
              if not cleaned_text.startswith('<div class="update-item"'):
                  print("âš ï¸ AI response doesn't start with expected HTML, but saving anyway")
              
              # Save the AI-generated content
              with open("new_update.html", "w") as f:
                  f.write(cleaned_text)
                  
              print("âœ… AI-generated content saved!")
              print("ğŸ“ Generated content:")
              print(cleaned_text)
              
          except Exception as e:
              print(f"âŒ AI generation failed: {e}")
              # Create a SIMPLE fallback that's still based on the commit
              print("ğŸ”„ Creating commit-specific fallback...")
              
              # Extract keywords from commit to make it specific
              commit_lower = commit_message.lower()
              if any(word in commit_lower for word in ['game', 'add', 'new']):
                  items = [
                      f"ğŸ® Added new games based on: {commit_message}",
                      "ğŸš€ Improved gaming experience and performance",
                      "âœ¨ Enhanced website features and user interface",
                      "ğŸ¯ Better gameplay and bug fixes"
                  ]
              elif any(word in commit_lower for word in ['fix', 'bug', 'error']):
                  items = [
                      f"ğŸ› Fixed issues: {commit_message}",
                      "ğŸš€ Improved stability and performance",
                      "âœ¨ Enhanced user experience",
                      "ğŸ® Better gameplay functionality"
                  ]
              elif any(word in commit_lower for word in ['update', 'change', 'modify']):
                  items = [
                      f"ğŸ”„ Updated: {commit_message}",
                      "ğŸš€ Enhanced website performance",
                      "âœ¨ Improved user interface and features",
                      "ğŸ® Better gaming experience"
                  ]
              else:
                  items = [
                      f"ğŸ¯ Changes: {commit_message}",
                      "ğŸš€ Performance improvements and updates",
                      "âœ¨ Enhanced gaming website features",
                      "ğŸ® Better user experience and gameplay"
                  ]
              
              fallback_html = f'''
              <div class="update-item" style="animation-delay: 0.1s;">
                <div class="update-header">
                  <div class="version-info">
                    <span class="version-badge">v{version_number}</span>
                    <h3 class="version-title">{version_name}</h3>
                  </div>
                  <span class="version-date">{today}</span>
                </div>
                <div class="update-content">
                  <ul class="update-list">
                    {''.join([f'<li>{item}</li>' for item in items])}
                  </ul>
                </div>
              </div>
              '''
              
              with open("new_update.html", "w") as f:
                  f.write(fallback_html.strip())
              print("ğŸ“ Commit-specific fallback saved")

          EOF

      - name: ğŸ“‹ Insert update into HTML
        run: |
          NEW_UPDATE=$(cat new_update.html)
          echo "Inserting AI-generated update..."
          
          # Remove any existing updates between the markers
          sed -i '/<!-- UPDATE_LOG_START -->/,/<!-- UPDATE_LOG_END -->/{//!d}' ul.html
          
          # Insert the new AI-generated update
          sed -i '/<!-- UPDATE_LOG_START -->/a\'$'\n''            '"$NEW_UPDATE" ul.html
          
          echo "âœ… Update inserted!"

      - name: ğŸ“¤ Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ul.html
          git diff --staged --quiet || git commit -m "ğŸ¤– AI Auto Update: $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: ğŸ§¹ Cleanup
        run: rm -f new_update.html commit_message.txt
