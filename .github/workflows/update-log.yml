name: ü§ñ AI Auto Update Log

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  generate-update:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, '[skip ci]') && !contains(github.event.head_commit.message, 'Auto AI Update Log')"

    steps:
      - name: üöÄ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìù Get commit and file changes with diffs
        run: |
          echo "=== TRIGGERING COMMIT ==="
          git log -1 --pretty=%B > commit_message.txt
          echo "=== CHANGED FILES ==="
          git diff --name-only HEAD~1 HEAD > changed_files.txt 2>/dev/null || echo "Initial commit" > changed_files.txt
          
          # Get the actual diff for each changed file
          echo "=== FILE DIFFS ===" > file_diffs.txt
          while IFS= read -r file; do
            if [[ -n "$file" && "$file" != "Initial commit" ]]; then
              echo "--- $file ---" >> file_diffs.txt
              git diff HEAD~1 HEAD -- "$file" >> file_diffs.txt 2>/dev/null || echo "No diff available" >> file_diffs.txt
              echo "" >> file_diffs.txt
            fi
          done < changed_files.txt
          
          cat commit_message.txt
          cat changed_files.txt
          echo "=== DIFFS PREVIEW ==="
          head -50 file_diffs.txt

      - name: ü§ñ Generate AI update block (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          sudo apt-get update
          sudo apt-get install -y python3 python3-pip
          pip3 install requests

          python3 << 'EOF'
          import requests, os, datetime, random

          # Read commit, file changes, and actual diffs
          commit_message = open("commit_message.txt").read().strip()
          changed_files = open("changed_files.txt").read().strip()
          file_diffs = open("file_diffs.txt").read().strip()
          today = datetime.date.today().strftime("%B %d, %Y")
          
          # Generate version number only (AI will create the title)
          version_number = f"1.{random.randint(1,20)}.{random.randint(0,9)}"

          api_key = os.environ["GEMINI_API_KEY"]
          url = f"https://generativelanguage.googleapis.com/v1/models/gemini-2.5-flash:generateContent?key={api_key}"
          
          print(f"üéØ Commit: {commit_message}")
          print(f"üìÅ Changed files: {changed_files}")
          print(f"üìÑ File diffs preview: {file_diffs[:500]}...")

          prompt = f"""
          Create an update card for an unblocked games website by analyzing the actual code changes.

          COMMIT MESSAGE: "{commit_message}"
          CHANGED FILES: {changed_files}

          ACTUAL CODE CHANGES (diff format):
          {file_diffs}

          Analyze the code changes and create:
          1. A RELEVANT TITLE that summarizes the changes
          2. ONE accurate description that explains:
             - What specific changes were made in the code
             - Which games/features were added, removed, or modified
             - How this affects the user experience

          Be specific about:
          - Game names if games were added/removed
          - UI/UX changes if CSS/HTML was modified
          - Performance improvements if technical changes were made
          - New features if functionality was added

          Return ONLY this HTML structure:

          <div class="update-item" style="animation-delay: 0.1s;">
            <div class="update-header">
              <div class="version-info">
                <span class="version-badge">v{version_number}</span>
                <h3 class="version-title">[AI-GENERATED RELEVANT TITLE]</h3>
              </div>
              <span class="version-date">{today}</span>
            </div>
            <div class="update-content">
              <ul class="update-list">
                <li>[AI-GENERATED DESCRIPTION WITH EMOJI BASED ON ACTUAL CODE CHANGES]</li>
              </ul>
            </div>
          </div>

          Make it accurate and specific to the code changes!
          """

          try:
              payload = {
                  "contents": [
                      {"parts": [{"text": prompt}]}
                  ],
                  "generationConfig": {
                      "temperature": 0.7,
                      "topK": 40,
                      "topP": 0.95,
                      "maxOutputTokens": 1200,
                  }
              }

              print("üöÄ Sending request to Gemini API...")
              response = requests.post(url, json=payload, timeout=30)
              print(f"üì° Response status: {response.status_code}")
              
              if response.status_code != 200:
                  print(f"‚ùå API Error {response.status_code}: {response.text}")
                  raise Exception(f"API returned {response.status_code}")
              
              result = response.json()
              
              # Extract text from response
              ai_text = ""
              if "candidates" in result and len(result["candidates"]) > 0:
                  candidate = result["candidates"][0]
                  if "content" in candidate and "parts" in candidate["content"] and len(candidate["content"]["parts"]) > 0:
                      ai_text = candidate["content"]["parts"][0].get("text", "")
              
              if not ai_text:
                  print(f"‚ùå No text in response: {result}")
                  raise Exception("No text content in API response")
              
              # Clean the response
              cleaned_text = ai_text.strip()
              cleaned_text = cleaned_text.replace('```html', '').replace('```', '').strip()
              
              # Save the AI-generated content
              with open("new_update.html", "w") as f:
                  f.write(cleaned_text)
                  
              print("‚úÖ AI-generated content saved!")
              print("üìù Generated content:")
              print(cleaned_text)
              
          except Exception as e:
              print(f"‚ùå AI generation failed: {e}")
              raise Exception("AI generation failed - no fallback template used")

          EOF

      - name: üìã Safe HTML insertion using Python
        run: |
          python3 << 'EOF'
          import re
          
          # Read the generated update
          with open("new_update.html", "r") as f:
              new_update = f.read().strip()
          
          # Read the current ul.html
          with open("ul.html", "r") as f:
              content = f.read()
          
          # Remove existing content between the markers
          pattern = r'(<!-- UPDATE_LOG_START -->\s*).*?(\s*<!-- UPDATE_LOG_END -->)'
          replacement = r'\1' + new_update + r'\2'
          
          new_content = re.sub(pattern, replacement, content, flags=re.DOTALL)
          
          # Write the updated content back
          with open("ul.html", "w") as f:
              f.write(new_content)
          
          print("‚úÖ Update successfully inserted into ul.html")
          EOF

      - name: üîç Verify the update was inserted
        run: |
          echo "=== VERIFYING INSERTION ==="
          if grep -q "update-item" ul.html; then
            echo "‚úÖ Update card found in ul.html"
            echo "=== FULL INSERTED CONTENT ==="
            sed -n '/<!-- UPDATE_LOG_START -->/,/<!-- UPDATE_LOG_END -->/p' ul.html
          else
            echo "‚ùå Error: Update card not found in HTML"
            exit 1
          fi

      - name: üì§ Commit and push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add ul.html
          git diff --staged --quiet || git commit -m "ü§ñ AI Auto Update: $(date +'%Y-%m-%d %H:%M')"
          git push

      - name: üßπ Cleanup
        run: rm -f new_update.html commit_message.txt changed_files.txt file_diffs.txt
