name: Auto Update Log

on:
  push:
    branches:
      - main

jobs:
  generate-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest commit message
        run: |
          echo "$(git log -1 --pretty=%B)" > commit.txt

      - name: Generate AI update log with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests, json, datetime, os

          # Read commit message
          commit_text = open("commit.txt").read().strip()
          today = datetime.date.today()

          api_key = os.environ["GEMINI_API_KEY"]
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={api_key}"

          prompt = f"""
          Create an HTML update card for my unblocked games website.

          FORMAT EXACTLY LIKE THIS:

          <div class="update-item">
              <div class="update-header">
                  <div class="version-info">
                      <span class="version-badge">AUTO</span>
                      <h3 class="version-title">Auto Update</h3>
                  </div>
                  <span class="version-date">{today}</span>
              </div>
              <div class="update-content">
                  <ul class="update-list">
                      <li>Describe update based on commit: {commit_text}</li>
                  </ul>
              </div>
          </div>

          ONLY output the HTML block. No extra text.
          """

          payload = {"contents":[{"parts":[{"text":prompt}]}]}

          res = requests.post(url, json=payload)

          text = res.json()["candidates"][0]["content"]["parts"][0]["text"]

          # Save HTML output
          open("update.html", "w").write(text.strip())
          EOF

      - name: Insert update into ul.html
        run: |
          # Insert the update at the top of the update log container

          UPDATE_CONTENT=$(cat update.html)

          # Replace placeholder <!-- AUTO-UPDATE-HERE -->
          sed -i "s|<!-- AUTO-UPDATE-HERE -->|${UPDATE_CONTENT}\n\n<!-- AUTO-UPDATE-HERE -->|" ul.html

      - name: Commit and push changes
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add ul.html
          git commit -m "Automated update log entry"
          git push
