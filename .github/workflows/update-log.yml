name: Auto Update Log

on:
  push:
    branches: [ "main" ]

jobs:
  generate-log:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Get latest commit message
        run: |
          git log -1 --pretty=format:"%s%n%n%b" > commit.txt

      - name: Install Python requests
        run: pip install requests

      - name: Generate update with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests, json, datetime

          commit_text = open("commit.txt").read()
          today = datetime.date.today()

          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${{GEMINI_API_KEY}}"

          prompt = f"""
          Create an HTML update card for my unblocked games website.

          MATCH THIS FORMAT EXACTLY:

          <div class="update-item">
              <div class="update-header">
                  <div class="version-info">
                      <span class="version-badge">AUTO</span>
                      <h3 class="version-title">Auto Update</h3>
                  </div>
                  <span class="version-date">{today}</span>
              </div>
              <div class="update-content">
                  <ul class="update-list">
                      <li>Summarize this commit: {commit_text}</li>
                  </ul>
              </div>
          </div>

          ONLY output the HTML block.
          """

          payload = {"contents":[{"parts":[{"text":prompt}]}]}
          res = requests.post(url, json=payload)
          text = res.json()["candidates"][0]["content"]["parts"][0]["text"]

          open("update.txt", "w").write(text)
          EOF

      - name: Insert update into ul.html
        run: |
          UPDATE_CONTENT="$(cat update.txt)"
          awk -v update="$UPDATE_CONTENT" '
            /<!-- UPDATE_LOG_START -->/ {print; print update; next}
            {print}
          ' ul.html > ul_updated.html
          mv ul_updated.html ul.html

      - name: Commit updated ul.html
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add ul.html
          git commit -m "Auto update log"
          git push
