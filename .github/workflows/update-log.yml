name: Auto Update Log

on:
  push:
    branches:
      - main

jobs:
  generate-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Get latest commit message
        run: echo "$(git log -1 --pretty=%B)" > commit.txt

      - name: Generate AI update block (Gemini)
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python3 << 'EOF'
          import requests, json, datetime, os

          commit_text = open("commit.txt").read().strip()
          today = datetime.date.today()

          api_key = os.environ["GEMINI_API_KEY"]
          url = f"https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key={api_key}"

          prompt = f"""
          Create an HTML update card matching this format:

          <div class="update-item">
              <div class="update-header">
                  <div class="version-info">
                      <span class="version-badge">AUTO</span>
                      <h3 class="version-title">Auto Update</h3>
                  </div>
                  <span class="version-date">{today}</span>
              </div>
              <div class="update-content">
                  <ul class="update-list">
                      <li>Describe what changed based on commit: {commit_text}</li>
                  </ul>
              </div>
          </div>

          Output ONLY the HTML. No commentary.
          """

          payload = {"contents":[{"parts":[{"text":prompt}]}]}

          response = requests.post(url, json=payload)
          text = response.json()["candidates"][0]["content"]["parts"][0]["text"]

          open("new_update.html", "w").write(text.strip())
          EOF

      - name: Insert update into ul.html
        run: |
          NEW_UPDATE=$(cat new_update.html)

          awk -v block="$NEW_UPDATE" '
            /<!-- UPDATE_LOG_START -->/ {print; print block; next}
            {print}
          ' ul.html > ul_new.html

          mv ul_new.html ul.html

      - name: Commit and push updates
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add ul.html
          git commit -m "Automated AI update log entry"
          git push
