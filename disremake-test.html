<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Discord-like Voice Chat</title>
<style>
  :root{
    --server-bar:#202225; --sidebar:#2f3136; --main:#36393f; --panel:#2b2d31; --accent:#7289da;
    --muted:#b9bbbe; --text:#e3e5e8;
  }
  html,body{margin:0;padding:0;height:100%;font-family:Inter,sans-serif;background:var(--main);color:var(--text);}
  .app{display:grid;grid-template-columns:72px 220px 1fr 200px;height:100vh;overflow:hidden;}
  
  /* Server bar */
  .server-bar{background:var(--server-bar);display:flex;flex-direction:column;align-items:center;padding:8px;gap:8px;}
  .server-icon{width:48px;height:48px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:bold;color:white;cursor:pointer;}
  
  /* Channels sidebar */
  .channels-bar{background:var(--sidebar);display:flex;flex-direction:column;padding:12px;gap:8px;}
  .channel-category{font-size:12px;color:var(--muted);text-transform:uppercase;margin-top:12px;margin-bottom:4px;}
  .channel{padding:6px 8px;border-radius:4px;display:flex;align-items:center;gap:4px;color:var(--muted);cursor:pointer;}
  .channel.active{background:rgba(114,137,218,0.12);color:var(--text);font-weight:600;}
  
  /* Main panel */
  .main-panel{background:var(--main);padding:12px;display:flex;flex-direction:column;}
  .room-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
  .room-title{font-size:16px;font-weight:700;}
  .controls{display:flex;gap:8px;align-items:center;}
  button{background:var(--panel);border:1px solid rgba(255,255,255,0.03);color:var(--text);padding:6px 10px;border-radius:6px;cursor:pointer;}
  .mutebtn{background:#202225;}
  .leave{background:#2b2b2b;color:#ff8b8b;}
  .mic-state{font-size:13px;}
  .participants-panel{background:var(--sidebar);padding:8px;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
  .participant{display:flex;align-items:center;gap:8px;padding:6px;border-radius:6px;background:var(--panel);}
  .avatar{width:32px;height:32px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#5b6bd1);display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:12px;}
  .pname{font-size:14px;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
  .pstatus{font-size:11px;color:var(--muted);}
</style>
</head>
<body>
<div class="app">
  <!-- Server bar -->
  <div class="server-bar">
    <div class="server-icon">S</div>
    <div class="server-icon">G</div>
    <div class="server-icon">L</div>
  </div>

  <!-- Channels sidebar -->
  <div class="channels-bar">
    <div class="channel-category">Voice Channels</div>
    <div class="channel active" data-room="general">ðŸ”Š general</div>
    <div class="channel" data-room="gaming">ðŸŽ® gaming</div>
    <div class="channel" data-room="lobby">ðŸ’¬ lobby</div>
    <div class="channel" data-room="music">ðŸŽµ music</div>
    <div style="margin-top:12px;font-size:12px;color:var(--muted);">Status: <span id="connStatus">disconnected</span></div>
  </div>

  <!-- Main panel -->
  <div class="main-panel">
    <div class="room-header">
      <div class="room-title" id="roomTitle"># general</div>
      <div class="controls">
        <div class="mic-state">Mic: <strong id="micState">off</strong></div>
        <button id="joinBtn">Join</button>
        <button id="leaveBtn" class="leave" style="display:none">Leave</button>
        <button id="toggleMute" class="mutebtn" style="display:none">Mute</button>
      </div>
    </div>
    <div id="participants" class="participants-panel"></div>
  </div>

  <!-- Members bar -->
  <div class="participants-panel" id="membersPanel">
    <div style="font-weight:700;margin-bottom:6px;">Members</div>
  </div>
</div>

<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>
<script>
// --------------------- CONFIG ---------------------
const CHANNEL_ID="YstSSj9UMw4xqYdB"; // replace with your ScaleDrone ID
const MAX_PARTICIPANTS=10;

// UI
const joinBtn=document.getElementById('joinBtn');
const leaveBtn=document.getElementById('leaveBtn');
const toggleMuteBtn=document.getElementById('toggleMute');
const micStateEl=document.getElementById('micState');
const participantsEl=document.getElementById('participants');
const membersPanel=document.getElementById('membersPanel');
const connStatus=document.getElementById('connStatus');
const roomTitle=document.getElementById('roomTitle');

let localStream=null,drone=null,room=null,clientId=null,peers={},isJoined=false,isMuted=false,currentRoom='general';

// --------------------- UTILS ---------------------
function shortId(){return Math.random().toString(36).substring(2,9);}
function setConn(text){connStatus.textContent=text;}
function getRandomName(){const names=["Axel","Nova","Zara","Echo","Luna","Kai","Rex","Mira","Jax","Vex"];return names[Math.floor(Math.random()*names.length)];}

// --------------------- PARTICIPANTS ---------------------
function renderParticipants(){
  participantsEl.innerHTML='';
  membersPanel.querySelectorAll('.participant').forEach(e=>e.remove());
  const ids=Object.keys(peers);
  const allIds=ids.slice(0,MAX_PARTICIPANTS);
  if(isJoined) allIds.unshift('local');

  allIds.forEach(id=>{
    let name='You', muted=false;
    if(id==='local'){name='You'; muted=isMuted;} 
    else {name=peers[id].name||getRandomName(); muted=peers[id].audioEl?.muted||false;}
    // main panel
    const div=document.createElement('div');
    div.className='participant';
    div.innerHTML=`<div class="avatar">${name.slice(0,2).toUpperCase()}</div><div class="pname">${name}</div><div class="pstatus">${muted?'muted':'speaking'}</div>`;
    participantsEl.appendChild(div);
    // members bar
    const div2=document.createElement('div');
    div2.className='participant';
    div2.innerHTML=`<div class="avatar">${name.slice(0,2).toUpperCase()}</div><div class="pname">${name}</div>`;
    membersPanel.appendChild(div2);
  });
}

// --------------------- MICROPHONE ---------------------
function toggleLocalMute(){
  if(!localStream) return;
  isMuted=!isMuted;
  localStream.getAudioTracks().forEach(t=>t.enabled=!isMuted);
  micStateEl.textContent=isMuted?'off':'on';
  toggleMuteBtn.textContent=isMuted?'Unmute':'Mute';
  renderParticipants();
}

// --------------------- AUDIO ---------------------
function createAudioEl(stream){const a=document.createElement('audio');a.autoplay=true;a.srcObject=stream;a.style.display='none';document.body.appendChild(a);return a;}
function closePeer(id){if(!peers[id]) return; try{peers[id].pc.close();}catch(e){} if(peers[id].audioEl) peers[id].audioEl.remove(); delete peers[id]; renderParticipants();}

// --------------------- LEAVE ROOM ---------------------
function leaveRoom(){
  Object.keys(peers).forEach(closePeer); peers={};
  if(localStream) localStream.getTracks().forEach(t=>t.stop()); localStream=null;
  if(room) try{room.unsubscribe();}catch(e){} if(drone) try{drone.close();}catch(e){}
  drone=null; room=null; clientId=null; isJoined=false; isMuted=false;
  micStateEl.textContent='off'; toggleMuteBtn.style.display='none'; leaveBtn.style.display='none'; joinBtn.style.display='';
  setConn('disconnected'); renderParticipants();
}

// --------------------- WEBRTC ---------------------
async function joinRoom(){
  if(!CHANNEL_ID || CHANNEL_ID==="YOUR_CHANNEL_ID"){ alert("Replace CHANNEL_ID"); return;}
  if(isJoined) return;
  drone=new ScaleDrone(CHANNEL_ID,{data:{name:getRandomName()}});
  setConn('connecting');
  drone.on('open',err=>{
    if(err){console.error(err); setConn('error'); return;}
    setConn('connected'); clientId=drone.clientId;
    room=drone.subscribe('observable-'+currentRoom);
    room.on('members',m=>renderParticipants());
    room.on('data',(msg,member)=>{
      if(!member) return; const from=member.id; if(from===clientId) return;
      if(msg.type==='offer'){const pc=preparePeer(from,false); pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)).then(()=>pc.createAnswer()).then(answer=>pc.setLocalDescription(answer)).then(()=>drone.publish({room:'observable-'+currentRoom,message:{type:'answer',sdp:pc.localDescription,name:msg.name}})).catch(console.error);}
      else if(msg.type==='answer'){const pcObj=peers[from]; if(pcObj&&pcObj.pc) pcObj.pc.setRemoteDescription(new RTCSessionDescription(msg.sdp)).catch(console.error);}
      else if(msg.type==='candidate'){const pcObj=peers[from]; if(pcObj&&pcObj.pc) pcObj.pc.addIceCandidate(new RTCIceCandidate(msg.candidate)).catch(console.error);}
    });

    navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
      localStream=stream; isMuted=false; micStateEl.textContent='on'; toggleMuteBtn.style.display=''; leaveBtn.style.display=''; joinBtn.style.display='none'; isJoined=true;
      renderParticipants();
      (room.members||[]).forEach(m=>{if(m.id!==clientId) createOffer(m.id,m.clientData?.name);});
      room.on('member_join',m=>{if(m.id!==clientId) createOffer(m.id,m.clientData?.name);});
    }).catch(err=>{console.error(err); alert('Mic required'); setConn('mic blocked');});
  });
  drone.on('close',()=>setConn('closed')); drone.on('error',err=>{console.error(err); setConn('error');});
}

// --------------------- PEER ---------------------
function preparePeer(id,isOfferer=true){
  if(peers[id]?.pc) return peers[id].pc;
  const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  peers[id]=peers[id]||{pc,audioEl:null,name:''}; peers[id].pc=pc;
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
  pc.onicecandidate=e=>{if(e.candidate) drone.publish({room:'observable-'+currentRoom,message:{type:'candidate',candidate:e.candidate}});};
  pc.ontrack=e=>{const stream=e.streams[0]?e.streams[0]:new MediaStream([e.track]); peers[id].audioEl=createAudioEl(stream); peers[id].name=peers[id].name||getRandomName(); renderParticipants();};
  pc.onconnectionstatechange=()=>{if(['failed','disconnected','closed'].includes(pc.connectionState)) closePeer(id);};
  return pc;
}

async function createOffer(id,name){const pc=preparePeer(id,true); peers[id].name=name||peers[id].name||getRandomName(); try{const offer=await pc.createOffer(); await pc.setLocalDescription(offer); drone.publish({room:'observable-'+currentRoom,message:{type:'offer',sdp:pc.localDescription,name:getRandomName()}});}catch(e){console.error(e);}

// --------------------- BUTTONS ---------------------
joinBtn.onclick=()=>joinRoom(); leaveBtn.onclick=leaveRoom; toggleMuteBtn.onclick=toggleLocalMute;

// --------------------- CHANNEL SWITCHING ---------------------
document.querySelectorAll('.channel').forEach(ch=>{
  ch.onclick=()=>{
    if(ch.dataset.room===currentRoom) return;
    document.querySelectorAll('.channel').forEach(c=>c.classList.remove('active'));
    ch.classList.add('active');
    currentRoom=ch.dataset.room; roomTitle.textContent='# '+currentRoom;
    if(isJoined) leaveRoom();
  };
});

renderParticipants(); setConn('idle');
</script>
</body>
</html>
